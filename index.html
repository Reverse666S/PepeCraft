<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>PepeCraft ‚Äì Clan Portal</title>
<link rel="icon" type="image/png" href="pepecraft.png">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--bg:#0f1220;--panel:#171a2b;--muted:#232742;--fg:#e6e8ff;--accent:#7c5cff;--good:#25c28a;--bad:#ff5c7c;--warn:#f5a524;}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:linear-gradient(180deg,#0b0e1a,#0f1220);color:var(--fg)}
a{color:var(--accent);text-decoration:none}img{max-width:100%}.wrap{max-width:1100px;margin:0 auto;padding:20px}header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 0}.brand{display:flex;gap:12px;align-items:center}.brand img{width:56px;height:56px;border-radius:14px;border:2px solid #0003}.brand h1{font-size:22px;margin:0;letter-spacing:.6px}.nav{display:flex;gap:8px;flex-wrap:wrap}.btn{background:var(--muted);color:var(--fg);border:1px solid #0005;border-radius:10px;padding:10px 14px;cursor:pointer;transition:.15s;font-weight:600}.btn:hover{transform:translateY(-1px);background:#2a2f57}.btn.primary{background:var(--accent);border-color:#0000}.btn.good{background:var(--good)}.btn.bad{background:var(--bad)}.btn.warn{background:var(--warn);color:#111}.btn.small{padding:6px 10px;font-size:14px}.grid{display:grid;gap:16px}@media(min-width:900px){.grid.cols-2{grid-template-columns:1fr 1fr}.grid.cols-3{grid-template-columns:repeat(3,1fr)}}.card{background:var(--panel);border:1px solid #0006;border-radius:16px;padding:16px}.card h3{margin:0 0 10px 0}.muted{color:#aab}.input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #0006;background:#11152b;color:var(--fg)}textarea{min-height:120px;resize:vertical}.row{display:flex;gap:10px;flex-wrap:wrap}.pill{padding:6px 10px;border-radius:999px;background:#232742;border:1px solid #0006;font-size:12px}.table{width:100%;border-collapse:collapse}.table th,.table td{padding:10px;border-bottom:1px solid #2a2e4d;text-align:left}.table th{color:#9db}.center{display:flex;align-items:center;justify-content:center}.right{margin-left:auto}.tag{font-size:12px;padding:3px 8px;border-radius:8px;background:#2b315d;border:1px solid #0006}.status{display:inline-flex;align-items:center;gap:8px;padding:10px;border-radius:12px;border:1px dashed #445}.kpi{background:linear-gradient(180deg,#1b1f39,#151932);padding:14px;border-radius:16px;border:1px solid #0006}.avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid #0005;background:#0003}.flex{display:flex;gap:12px;align-items:center}.hidden{display:none !important}footer{opacity:.7;padding:30px 0}.badge{background:#2c315d;border:1px solid #0007;border-radius:999px;padding:4px 10px;font-size:12px}.support-type{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:12px}.support-type button{height:70px}.toast{position:fixed;bottom:16px;right:16px;background:#1d2244;border:1px solid #0006;padding:12px 14px;border-radius:12px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://nejriqvvzdffkmycrair.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lanJpcXZ2emRmZmtteWNyYWlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjQwOTcsImV4cCI6MjA3MjM0MDA5N30.tNERQEyFU1pwuAJglZzJl6KVOAlLek8eQNI3vY8LT3E";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const qs = s => document.querySelector(s);
const el = (t,cls) => Object.assign(document.createElement(t),{className:cls||""});

function toast(msg,err){const t=qs("#toast");t.textContent=msg;t.style.borderColor=err?"#ff6b81":"#0006";t.classList.remove("hidden");setTimeout(()=>t.classList.add("hidden"),2000);}
async function fileToDataUrl(file){return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});}

// --- SESSION & AUTH ---
function session(){return JSON.parse(localStorage.getItem("pc_session")||"null");}
async function login(username,password){
    const {data,error} = await supabase.from('users').select('*').eq('username',username).single();
    if(error || !data || data.pass!==password){toast("Falsche Zugangsdaten",true); return null;}
    localStorage.setItem("pc_session",JSON.stringify(data));
    renderTop(); routeTo("home"); toast("Angemeldet als "+data.username); return data;
}
function logout(){localStorage.removeItem("pc_session"); renderTop(); routeTo("login");}

// --- PERMISSIONS ---
function can(view){
    const me=session(); if(!me) return false;
    if(me.role==="owner") return true;
    const map={admin:["admin","owner"],member:["member","admin","owner"]};
    if(view==="owner") return me.role==="owner";
    if(view==="admin") return map.admin.includes(me.role);
    return map.member.includes(me.role);
}

// --- UI TOP ---
function renderTop(){
    const me=session();
    qs("#who")?.remove();
    const nav=qs("#topNav"); nav.innerHTML="";
    const add=(label,view,guard)=>{if(guard===false)return;const b=el("button","btn small");b.textContent=label;b.onclick=()=>routeTo(view);nav.appendChild(b);};
    add("Start","home",true);
    add("Mitglieder","members",true);
    add("Team","team",true);
    add("Links","links",true);
    add("Support","support",true);
    add("Konten","accounts",can("admin"));
    add("Adminpanel","admin",can("admin"));
    if(me){
        const prof=el("button","btn small"); prof.textContent="Profil"; prof.onclick=()=>routeTo("profile"); nav.appendChild(prof);
        const out=el("button","btn small bad"); out.textContent="Logout"; out.onclick=logout; nav.appendChild(out);
    } else {
        const inn=el("button","btn small primary"); inn.textContent="Login"; inn.onclick=()=>routeTo("login"); nav.appendChild(inn);
    }
}

// --- TABLE & KPI ---
function table(headers,rows){const t=el("table","table");const thead=el("thead"); const trh=el("tr"); headers.forEach(h=>{const th=el("th");th.innerHTML=h; trh.appendChild(th);}); thead.appendChild(trh); t.appendChild(thead); const tb=el("tbody"); rows.forEach(r=>{const tr=el("tr"); r.forEach(c=>{const td=el("td"); td.innerHTML=c; tr.appendChild(td);}); tb.appendChild(tr);}); t.appendChild(tb); return t;}
function cardKPI(label,val){const c=el("div","kpi");c.innerHTML=`<div class="muted">${label}</div><div style="font-size:28px;font-weight:800">${val}</div>`;return c;}
function denyCard(txt){const c=el("div","card");c.innerHTML=`<div class="status">üîí ${txt||"Keine Berechtigung"}</div>`;return c;}

// --- ROUTES ---
const routes = {
login(){
    const c=el("div","grid cols-2");
    const left=el("div","card");
    left.innerHTML=`<h3>Login</h3><div class="muted">Der Seiteninhaber legt Accounts an.</div><div class="row" style="margin-top:10px"><input class="input" id="u" placeholder="Username"><input class="input" id="p" placeholder="Passwort" type="password"><button class="btn primary" id="go">Einloggen</button></div>`;
    left.querySelector("#go").onclick=()=>login(left.querySelector("#u").value.trim(), left.querySelector("#p").value);
    const right=el("div","card center"); right.innerHTML=`<img src="pepecraft.png" style="max-height:220px;border-radius:16px;border:1px solid #0006">`;
    c.append(left,right); return c;
},

home: async function(){
    let { data: home, error } = await supabase.from('home').select('*').limit(1).single();
    if(error || !home) home = {title:"Willkommen", content:"Bearbeite das Adminpanel", hero:"pepecraft.png"};

    const wrap = el("div","grid cols-2");
    const heroCard = el("div","card");
    heroCard.innerHTML = `
        <img src="${home.hero}" style="width:100%;border-radius:14px;border:1px solid #0006">
        <h2 style="margin:12px 0 6px 0">${home.title}</h2>
        <p class="muted">${home.content}</p>
        <div class="row">
            <span class="badge">Clan Portal</span>
            <span class="badge">Minecraft</span>
            <span class="badge">Support</span>
        </div>`;
    wrap.appendChild(heroCard);

    const { data: members } = await supabase.from('members').select('*');
    const { data: users } = await supabase.from('users').select('*');
    const { data: supports } = await supabase.from('supports').select('*');

    const stats = el("div","grid");
    stats.appendChild(cardKPI("Mitglieder", members ? members.length : 0));
    stats.appendChild(cardKPI("Accounts", users ? users.length : 0));
    stats.appendChild(cardKPI("Support-Tickets", supports ? supports.length : 0));
    wrap.appendChild(stats);

    return wrap;
},

members: async function(){
    const {data:members} = await supabase.from('members').select('*');
    const wrap=el("div","grid");
    const rows=members.map((m,i)=>[m.ign,m.discord,(m.ranks||[]).join(","),can("admin")?`<button class="btn small bad" onclick="delMember(${i})">L√∂schen</button>`:""]);
    const c=el("div","card"); c.innerHTML="<h3>Mitglieder</h3>"; c.appendChild(table(["IGN","Discord","R√§nge","Aktion"],rows));
    if(can("admin")) c.appendChild(cardMemberForm());
    wrap.appendChild(c); return wrap;
},

accounts: async function(){
    if(!can("admin")) return denyCard();
    const {data:users}=await supabase.from('users').select('*');
    const wrap=el("div","grid");
    const rows=users.map(u=>[`<div class="flex"><img class="avatar" src="${u.avatar||'pepecraft.png'}"><b>${u.username}</b></div>`,`<span class="tag">${u.role}</span>`,new Date(u.created).toLocaleDateString(),`<button class="btn small bad" onclick="delUser(${u.id})">L√∂schen</button>`]);
    const c=el("div","card"); c.innerHTML="<h3>Alle Konten</h3>"; c.appendChild(table(["Avatar/Name","Rolle","Seit","Aktion"],rows)); wrap.appendChild(c); return wrap;
},

profile: async function(){
    const me=session(); if(!me) return denyCard("Bitte zuerst einloggen.");
    const card=el("div","card"); card.innerHTML=`<h3>Profil</h3><div class="flex"><img class="avatar" id="pfp" src="${me.avatar||'pepecraft.png'}"><div class="row"><input class="input" id="np" type="password" placeholder="Neues Passwort"><input class="input" id="av" type="file" accept="image/*"></div><button class="btn primary right" id="savep">Speichern</button></div>`;
    card.querySelector("#savep").onclick=async()=>{
        const np=card.querySelector("#np").value; const file=card.querySelector("#av").files[0];
        if(np) await supabase.from('users').update({pass:np}).eq('id',me.id);
        if(file){ const b64=await fileToDataUrl(file); await supabase.from('users').update({avatar:b64}).eq('id',me.id); }
        const {data}=await supabase.from('users').select('*').eq('id',me.id).single();
        localStorage.setItem("pc_session",JSON.stringify(data)); renderTop(); toast("Profil aktualisiert");
    }; return card;
},

admin: async function(){
    if(!can("admin")) return denyCard();
    const wrap=el("div","grid cols-2");
    wrap.appendChild(cardCreateUser());
    wrap.appendChild(await routes.accounts());
    wrap.appendChild(await routes.members());
    return wrap;
}
};

// --- HELPER CARDS ---
function cardCreateUser(){
    const c=el("div","card"); c.innerHTML=`<h3>Account erstellen</h3><div class="row"><input class="input" id="cu_u" placeholder="Username"><input class="input" id="cu_p" placeholder="Passwort"><select class="input" id="cu_r"><option value="member">member</option><option value="admin">admin</option><option value="owner">owner</option></select><button class="btn primary" id="cu_s">Anlegen</button></div>`;
    c.querySelector("#cu_s").onclick=async()=>{
        const u=c.querySelector("#cu_u").value.trim(),p=c.querySelector("#cu_p").value.trim(),r=c.querySelector("#cu_r").value;
        if(!u||!p){toast("Username & Passwort angeben",true); return;}
        const {data:existing}=await supabase.from('users').select('*').eq('username',u).single();
        if(existing){toast("Username existiert bereits",true); return;}
        await supabase.from('users').insert([{username:u,pass:p,role:r,avatar:"",created:Date.now()}]); toast("Account erstellt"); routeTo("admin");
    }; return c;
}

function cardMemberForm(){
    const c=el("div","card"); c.innerHTML=`<h3>Mitglied hinzuf√ºgen</h3><div class="row"><input class="input" id="m_ign" placeholder="IGN"><input class="input" id="m_dis" placeholder="Discord"><input class="input" id="m_rnk" placeholder="R√§nge, Komma getrennt"><button class="btn primary" id="m_s">Hinzuf√ºgen</button></div>`;
    c.querySelector("#m_s").onclick=async()=>{
        const ign=c.querySelector("#m_ign").value.trim(); const dis=c.querySelector("#m_dis").value.trim(); const rnk=c.querySelector("#m_rnk").value.split(",").map(x=>x.trim());
        if(!ign){toast("IGN fehlt",true); return;}
        const {data:arr} = await supabase.from('members').select('*'); arr.push({ign,discord:dis,ranks:rnk});
        await supabase.from('members').delete().neq('ign',''); // l√∂sche alle vorherigen
        await supabase.from('members').insert(arr); toast("Mitglied hinzugef√ºgt"); routeTo("members");
    }; return c;
}

// --- DELETE ---
async function delUser(id){ if(!confirm("Konto wirklich l√∂schen?")) return; await supabase.from('users').delete().eq('id',id); toast("Konto gel√∂scht"); routeTo("accounts"); }
async function delMember(i){ const {data:arr}=await supabase.from('members').select('*'); arr.splice(i,1); await supabase.from('members').delete().neq('ign',''); await supabase.from('members').insert(arr); toast("Mitglied entfernt"); routeTo("members"); }

// --- ROUTE HANDLER ---
async function routeTo(name){
    try{ const routeFn = routes[name]; if(!routeFn) throw new Error("Route existiert nicht"); qs("#route").innerHTML="Lade..."; const content = await routeFn(); qs("#route").innerHTML=""; qs("#route").appendChild(content);
    }catch(e){qs("#route").innerHTML=`<div class="card">Fehler: ${e.message}</div>`;}
}

// --- INIT ---
document.addEventListener("DOMContentLoaded",()=>{renderTop(); routeTo(session()? "home":"login");});
</script>
</head>
<body>
<header class="wrap">
  <div class="brand">
    <img src="pepecraft.png" alt="Logo">
    <h1>PepeCraft</h1>
  </div>
  <div id="topNav" class="nav"></div>
</header>
<main class="wrap" id="route"></main>
<footer class="wrap">&copy; 2025 PepeCraft Clan Portal</footer>
<div id="toast" class="toast hidden"></div>
</body>
</html>
