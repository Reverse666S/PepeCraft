<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>PepeCraft ‚Äì Clan Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --muted:#232742; --fg:#e6e8ff;
      --accent:#7c5cff; --good:#25c28a; --bad:#ff5c7c; --warn:#f5a524;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
         background:linear-gradient(180deg,#0b0e1a, #0f1220); color:var(--fg)}
    a{color:var(--accent);text-decoration:none}
    img{max-width:100%}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:56px;height:56px;border-radius:14px;border:2px solid #0003}
    .brand h1{font-size:22px;margin:0;letter-spacing:.6px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--muted);color:var(--fg);border:1px solid #0005;border-radius:10px;
         padding:10px 14px;cursor:pointer;transition:.15s;font-weight:600}
    .btn:hover{transform:translateY(-1px);background:#2a2f57}
    .btn.primary{background:var(--accent);border-color:#0000}
    .btn.good{background:var(--good)}
    .btn.bad{background:var(--bad)}
    .btn.warn{background:var(--warn);color:#111}
    .btn.small{padding:6px 10px;font-size:14px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)} }
    .card{background:var(--panel);border:1px solid #0006;border-radius:16px;padding:16px}
    .card h3{margin:0 0 10px 0}
    .muted{color:#aab}
    .input, textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid #0006;background:#11152b;color:var(--fg)}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#232742;border:1px solid #0006;font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #2a2e4d;text-align:left}
    .table th{color:#9db}
    .center{display:flex;align-items:center;justify-content:center}
    .right{margin-left:auto}
    .tag{font-size:12px;padding:3px 8px;border-radius:8px;background:#2b315d;border:1px solid #0006}
    .status{display:inline-flex;align-items:center;gap:8px;padding:10px;border-radius:12px;border:1px dashed #445}
    .kpi{background:linear-gradient(180deg,#1b1f39,#151932);padding:14px;border-radius:16px;border:1px solid #0006}
    .avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid #0005;background:#0003}
    .flex{display:flex;gap:12px;align-items:center}
    .hidden{display:none !important}
    footer{opacity:.7;padding:30px 0}
    .badge{background:#2c315d;border:1px solid #0007;border-radius:999px;padding:4px 10px;font-size:12px}
    .support-type{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:12px}
    .support-type button{height:70px}
    .toast{position:fixed;bottom:16px;right:16px;background:#1d2244;border:1px solid #0006;padding:12px 14px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="pepecraft.png" alt="PepeCraft Logo" />
        <div>
          <h1>PEPECRAFT ‚Äì Clan Portal</h1>
          <div class="muted" id="who"></div>
        </div>
      </div>
      <nav class="nav" id="topNav"></nav>
    </header>

    <main id="route"></main>

    <footer class="center">
      <div class="muted">¬© <span id="yr"></span> PepeCraft ¬∑ Demo mit Supabase</div>
    </footer>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Supabase + SPA Script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // =====================
    // Supabase Setup
    // =====================
    const SUPA_URL = "https://nejriqvvzdffkmycrair.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lanJpcXZ2emRmZmtteWNyYWlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjQwOTcsImV4cCI6MjA3MjM0MDA5N30.tNERQEyFU1pwuAJglZzJl6KVOAlLek8eQNI3vY8LT3E";
    const supabase = createClient(SUPA_URL, SUPA_KEY);

    let sessionUser = null;

    async function fetchSession(){ return sessionUser; }

    async function getUsers(){ const { data } = await supabase.from('users').select('*'); return data||[]; }
    async function updateUser(id, updates){ await supabase.from('users').update(updates).eq('id', id); }
    async function deleteUser(id){ await supabase.from('users').delete().eq('id', id); }
    async function getMembers(){ const { data } = await supabase.from('members').select('*'); return data||[]; }
    async function addMember(obj){ await supabase.from('members').insert([obj]); }
    async function deleteMember(id){ await supabase.from('members').delete().eq('id', id); }
    async function getLinks(){ const { data } = await supabase.from('links').select('*'); return data||[]; }
    async function addLink(obj){ await supabase.from('links').insert([obj]); }
    async function deleteLink(id){ await supabase.from('links').delete().eq('id', id); }
    async function getSupports(){ const { data } = await supabase.from('supports').select('*'); return data||[]; }
    async function addSupport(obj){ await supabase.from('supports').insert([obj]); }
    async function deleteSupport(id){ await supabase.from('supports').delete().eq('id', id); }

    // =====================
    // Helpers
    // =====================
    const qs = s=>document.querySelector(s);
    const el = (t,cls)=>Object.assign(document.createElement(t),{className:cls||""});
    function toast(msg, err){ const t=qs("#toast"); t.textContent=msg; t.style.borderColor=err?"#ff6b81":"#0006"; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),2000);}
    function fileToDataUrl(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); }); }

    // =====================
    // Role System
    // =====================
    function can(view){
      const me = sessionUser;
      if(!me) return false;
      if(me.role==="owner") return true;
      const map = { admin:["admin","owner"], member:["member","admin","owner"] };
      if(view==="owner") return me.role==="owner";
      if(view==="admin") return map.admin.includes(me.role);
      return map.member.includes(me.role);
    }

    // =====================
    // Navbar
    // =====================
    function renderTop(){
      const me=sessionUser;
      qs("#who").textContent = me? `Eingeloggt: ${me.username} (${me.role})`:"Nicht eingeloggt";
      const nav=qs("#topNav"); nav.innerHTML="";
      const add=(label,view,guard)=>{ if(guard===false) return; const b=el("button","btn small"); b.textContent=label; b.onclick=()=>routeTo(view); nav.appendChild(b); };
      add("Start","home",true); add("Mitglieder","members",true); add("Team","team",true);
      add("Links","links",true); add("Support","support",true);
      add("Konten","accounts",can("admin")); add("Adminpanel","admin",can("admin"));
      if(me){
        const prof=el("button","btn small"); prof.textContent="Profil"; prof.onclick=()=>routeTo("profile"); nav.appendChild(prof);
        const out=el("button","btn small bad"); out.textContent="Logout"; out.onclick=()=>{sessionUser=null; renderTop(); routeTo("login");}; nav.appendChild(out);
      } else{
        const inn=el("button","btn small primary"); inn.textContent="Login"; inn.onclick=()=>routeTo("login"); nav.appendChild(inn);
      }
    }

    // =====================
    // Routes
    // =====================
    const routes = {};
// =====================
// Members
// =====================
routes.members = async function() {
  const wrap = el("div","grid");
  const members = await getMembers();

  const tableCard = el("div","card");
  tableCard.innerHTML = "<h3>Clanmitglieder</h3>";
  const rows = members.map(m => [
    `<b>${m.ign}</b>`,
    m.discord,
    m.ranks.join(", "),
    can("admin") ? `<button class="btn small bad" onclick="delMemberSup('${m.id}')">Entfernen</button>` : ""
  ]);
  tableCard.appendChild(table(["Ingame","Discord","R√§nge","Aktion"], rows));
  wrap.appendChild(tableCard);

  if(can("admin")){
    const form = el("div","card");
    form.innerHTML=`
      <h3>Mitglied eintragen</h3>
      <div class="row">
        <input id="mi" class="input" placeholder="Ingame-Name">
        <input id="md" class="input" placeholder="Discord-Name">
        <input id="mr" class="input" placeholder="R√§nge (Komma getrennt)">
        <button class="btn primary" id="ms">Speichern</button>
      </div>`;
    form.querySelector("#ms").onclick = async () => {
      const ign = form.querySelector("#mi").value.trim();
      const disc = form.querySelector("#md").value.trim();
      const ranks = form.querySelector("#mr").value.split(",").map(s=>s.trim()).filter(Boolean);
      if(!ign) return toast("Ingame-Name erforderlich", true);
      await addMember({ign, discord:disc, ranks});
      toast("Mitglied gespeichert");
      routeTo("members");
    };
    wrap.appendChild(form);
  }

  return wrap;
};

async function delMemberSup(id){ if(!confirm("Mitglied l√∂schen?")) return; await deleteMember(id); toast("Mitglied entfernt"); routeTo("members"); }


// =====================
// Accounts
// =====================
routes.accounts = async function() {
  if(!can("admin")) return denyCard();
  const wrap = el("div","grid");
  const users = await getUsers();
  const card = el("div","card");
  card.innerHTML="<h3>Alle Konten</h3>";
  const rows = users.map(u=>[
    `<div class="flex"><img class="avatar" src="${u.avatar||'pepecraft.png'}"> <b>${u.username}</b></div>`,
    `<span class="tag">${u.role}</span>`,
    new Date(u.created).toLocaleDateString(),
    sessionUser?.id===u.id ? "‚Äî" : `
      <div class="row">
        <button class="btn small" onclick="setRoleSup('${u.id}','member')">member</button>
        <button class="btn small" onclick="setRoleSup('${u.id}','admin')">admin</button>
        ${can('owner')? `<button class="btn small warn" onclick="setRoleSup('${u.id}','owner')">owner</button>` : ""}
        <button class="btn small bad" onclick="delUserSup('${u.id}')">l√∂schen</button>
      </div>`
  ]);
  card.appendChild(table(["Konto","Rolle","Seit","Aktionen"], rows));
  wrap.appendChild(card);
  return wrap;
};

async function delUserSup(id){ if(!confirm("Konto l√∂schen?")) return; await deleteUser(id); toast("Konto gel√∂scht"); routeTo("accounts"); }
async function setRoleSup(id, role){ await updateUser(id,{role}); toast("Rolle ge√§ndert"); routeTo("accounts"); }    

// =========================
// Team
// =========================
routes.team = async function(){
  const wrap = el("div","card");
  wrap.innerHTML="<h3>Teammitglieder</h3>";
  const users = await getUsers();
  const staff = users.filter(u=>u.role!=="member");
  const rows = staff.map(u => [
    `<img class="avatar" src="${u.avatar||'pepecraft.png'}"> <b>${u.username}</b>`,
    `<span class="tag">${u.role}</span>`,
    new Date(u.created).toLocaleDateString()
  ]);
  wrap.appendChild(table(["Avatar","Username","Rolle","Seit"], rows));
  return wrap;
};

// =====================
// Links
// =====================
routes.links = async function() {
  const wrap = el("div","grid cols-2");
  const links = await getLinks();

  const listCard = el("div","card");
  listCard.innerHTML="<h3>Links</h3>";
  const rows = links.map(l=>[
    `<span class="tag">${l.name}</span>`,
    `<a href="${l.url}" target="_blank">${l.url}</a>`,
    can("admin")? `<button class="btn small bad" onclick="delLinkSup('${l.id}')">L√∂schen</button>`:""
  ]);
  listCard.appendChild(table(["Name","URL","Aktion"], rows));
  wrap.appendChild(listCard);

  if(can("admin")){
    const form = el("div","card");
    form.innerHTML=`
      <h3>Link hinzuf√ºgen</h3>
      <div class="row">
        <input class="input" id="ln" placeholder="Name">
        <input class="input" id="lu" placeholder="https://...">
        <button class="btn primary" id="ls">Speichern</button>
      </div>`;
    form.querySelector("#ls").onclick = async()=>{
      const n = form.querySelector("#ln").value.trim();
      const u = form.querySelector("#lu").value.trim();
      if(!n||!u) return toast("Name & URL angeben", true);
      await addLink({name:n, url:u});
      toast("Link gespeichert");
      routeTo("links");
    };
    wrap.appendChild(form);
  }

  return wrap;
};

async function delLinkSup(id){ if(!confirm("Link l√∂schen?")) return; await deleteLink(id); toast("Link gel√∂scht"); routeTo("links"); }

// =====================
// Support
// =====================
routes.support = async function() {
  const wrap = el("div","grid");
  const supports = await getSupports();

  // Header KPIs
  const head = el("div","grid cols-3");
  const userSupports = supports.filter(s=>s.by===sessionUser?.username).length;
  head.appendChild(cardKPI("Deine Eintr√§ge diese Woche", userSupports));
  head.appendChild(cardKPI("Gesamt Supports", supports.length));

  const counts = {};
  supports.forEach(s=>counts[s.by]=(counts[s.by]||0)+1);
  const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,3).map((t,i)=>`#${i+1} ${t[0]} ‚Äì ${t[1]}`).join("<br>") || "‚Äî";
  head.appendChild(cardKPI("Teamranking (Top)", top));
  wrap.appendChild(head);

  // Form
  const form = el("div","card");
  form.innerHTML=`
    <h3>üéß Neuen Support eintragen</h3>
    <div class="row">
      <div style="flex:1"><label class="muted">Dein Name</label><input class="input" id="s_by" value="${sessionUser?.username||''}"></div>
      <div style="flex:1"><label class="muted">Spieler Name</label><input class="input" id="s_who"></div>
    </div>
    <div class="support-type" style="margin:12px 0">
      <button class="btn good" onclick="markStatusSup('gel√∂st')">‚úî Gel√∂st</button>
      <button class="btn bad" onclick="markStatusSup('nicht_gel√∂st')">‚úñ Nicht Gel√∂st</button>
      <button class="btn" onclick="markStatusSup('kl√§rung')">‚ùì Weitere Kl√§rung</button>
      <button class="btn warn" onclick="markStatusSup('weitergeleitet')">‚û° Weitergeleitet</button>
    </div>
    <textarea class="input" id="s_desc" placeholder="Kurzbeschreibung"></textarea>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="s_save">üìù Support eintragen</button>
    </div>`;
  let currentStatus = "kl√§rung";
  window.markStatusSup = s => { currentStatus=s; toast("Status: "+s); };
  form.querySelector("#s_save").onclick = async () => {
    const by = form.querySelector("#s_by").value.trim();
    const who = form.querySelector("#s_who").value.trim();
    const desc = form.querySelector("#s_desc").value.trim();
    if(!by||!who) return toast("Dein Name und Spielername erforderlich", true);
    await addSupport({id:crypto.randomUUID(), by, who, desc, status:currentStatus, at:Date.now()});
    toast("Support gespeichert");
    routeTo("support");
  };
  wrap.appendChild(form);

  // List
  const list = el("div","card");
  list.innerHTML="<h3>Support-Eintr√§ge</h3>";
  const rows = supports.slice().reverse().map(s=>[
    new Date(s.at).toLocaleString(),
    s.by,
    s.who,
    `<span class="tag">${s.status}</span>`,
    s.desc||"",
    can("admin")? `<button class="btn small bad" onclick="delSupportSup('${s.id}')">L√∂schen</button>` : ""
  ]);
  list.appendChild(table(["Zeit","Von","Spieler","Status","Beschreibung","Aktion"], rows));
  wrap.appendChild(list);

  return wrap;
};

async function delSupportSup(id){ if(!confirm("Eintrag l√∂schen?")) return; await deleteSupport(id); toast("Eintrag gel√∂scht"); routeTo("support"); }

// =========================
// Admin Panel (Kombi)
// =========================
routes.admin = async function(){ return can("admin") ? await routes.accounts() : denyCard(); }


// =====================
// Home
// =====================
routes.home = async function() {
  const wrap = el("div","grid cols-2");
  const homeData = await getHome();
  const members = await getMembers();
  const users = await getUsers();
  const supports = await getSupports();

  const hero = el("div","card");
  hero.innerHTML = `
    <img src="${homeData.hero||'pepecraft.png'}" alt="Hero" style="width:100%;border-radius:14px;border:1px solid #0006">
    <h2 style="margin:12px 0 6px 0">${homeData.title||'PepeCraft'}</h2>
    <p class="muted">${homeData.content||''}</p>
    <div class="row">
      <span class="badge">Clan Portal</span>
      <span class="badge">Minecraft</span>
      <span class="badge">Support</span>
    </div>`;
  wrap.appendChild(hero);

  const stats = el("div","grid");
  stats.appendChild(cardKPI("Mitglieder", members.length));
  stats.appendChild(cardKPI("Accounts", users.length));
  stats.appendChild(cardKPI("Support-Tickets", supports.length));
  wrap.appendChild(stats);

  if(can("admin")){
    const edit = el("div","card");
    edit.innerHTML = `
      <h3>Startseite bearbeiten</h3>
      <div class="row"><input id="t" class="input" value="${homeData.title||''}" placeholder="Titel"></div>
      <div class="row"><input id="h" class="input" value="${homeData.hero||'pepecraft.png'}" placeholder="Hero-Bildpfad"></div>
      <div class="row"><textarea id="c" class="input" placeholder="Inhalt">${homeData.content||''}</textarea></div>
      <button class="btn primary" id="save">Speichern</button>`;
    edit.querySelector("#save").onclick = async () => {
      await saveHome({
        title: edit.querySelector("#t").value,
        hero: edit.querySelector("#h").value,
        content: edit.querySelector("#c").value
      });
      toast("Startseite aktualisiert");
      routeTo("home");
    };
    wrap.appendChild(edit);
  }

  return wrap;
};

// =========================
// Login
// =========================
routes.login = async function() {
  const wrap = el("div","grid");
  const card = el("div","card");
  card.innerHTML = `
    <h3>Login</h3>
    <div class="row">
      <input id="e" class="input" type="email" placeholder="Email">
      <input id="p" class="input" type="password" placeholder="Passwort">
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="loginBtn">Login</button>
      <button class="btn" id="regBtn">Registrieren</button>
    </div>`;
  
  card.querySelector("#loginBtn").onclick = async () => {
    const email = card.querySelector("#e").value.trim();
    const pass = card.querySelector("#p").value.trim();
    if(!email || !pass) return toast("Email und Passwort erforderlich", true);

    // Supabase Login
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if(error) return toast("Login fehlgeschlagen: " + error.message, true);

    // Benutzerinfos aus 'users' Tabelle holen
    const { data: userData } = await supabase.from('users').select('*').eq('id', data.user.id).single();
    sessionUser = userData;
    toast("Erfolgreich eingeloggt");
    renderTop();
    routeTo("home");
  };

  card.querySelector("#regBtn").onclick = async () => {
    const email = card.querySelector("#e").value.trim();
    const pass = card.querySelector("#p").value.trim();
    if(!email || !pass) return toast("Email und Passwort erforderlich", true);

    // Supabase Registrierung
    const { data, error } = await supabase.auth.signUp({ email, password: pass });
    if(error) return toast("Registrierung fehlgeschlagen: " + error.message, true);

    // Neuen Benutzer in 'users' Tabelle anlegen
    await supabase.from('users').insert([{ id: data.user.id, username: email.split('@')[0], role: 'member', created: Date.now() }]);
    toast("Registrierung erfolgreich. Bitte Login.");
  };

  wrap.appendChild(card);
  return wrap;
};      

// =====================
// Profile
// =====================
routes.profile = async function() {
  if(!sessionUser) return denyCard("Bitte zuerst einloggen.");
  const card = el("div","card");
  card.innerHTML=`
    <h3>Profil</h3>
    <div class="flex">
      <img class="avatar" id="pfp" src="${sessionUser.avatar||'pepecraft.png'}">
      <div class="row">
        <input class="input" id="np" type="password" placeholder="Neues Passwort (leer = unver√§ndert)">
        <input class="input" id="av" type="file" accept="image/*">
      </div>
      <button class="btn primary right" id="savep">Speichern</button>
    </div>`;
  card.querySelector("#savep").onclick = async ()=>{
    const np = card.querySelector("#np").value;
    const file = card.querySelector("#av").files[0];
    const updates = {};
    if(np) updates.pass=np;
    if(file){ 
      const b64 = await fileToDataUrl(file);
      updates.avatar=b64;
    }
    await updateUser(sessionUser.id, updates);
    sessionUser = {...sessionUser, ...updates};
    toast("Profil aktualisiert");
    renderTop();
    routeTo("profile");
  };
  return card;
};
// =========================
// Helpers
// =========================
function fileToDataUrl(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); }); }

    async function routeTo(name){
      const host = qs("#route"); host.innerHTML="";
      const view = routes[name] || routes.home;
      host.appendChild(await view());
      window.scrollTo({top:0,behavior:"smooth"});
    }

    // =====================
    // Boot
    // =====================
    qs("#yr").textContent = new Date().getFullYear();
    renderTop();
    routeTo((location.hash||"#home").slice(1));
    window.addEventListener("hashchange",()=>routeTo((location.hash||"#home").slice(1)));
  </script>
</body>
</html>
